<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FarmSupport - Your Digital Agri-Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Plus+Jakarta+Sans", sans-serif;
        background-color: #f7f9f6;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .chat-container {
        height: calc(100vh - 200px);
      }
      .bg-farm-primary {
        background-color: #3d5a2a;
      }
      .text-farm-primary {
        color: #3d5a2a;
      }
      .message-user {
        background: #3d5a2a;
        color: white;
        border-radius: 18px 18px 0 18px;
      }
      .message-bot {
        background: white;
        color: #1a2e05;
        border-radius: 18px 18px 18px 0;
        border: 1px solid #e2e8f0;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 10px;
      }
      .loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3d5a2a;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="overflow-hidden">
    <!-- Navigation -->
    <nav
      class="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-50"
    >
      <div class="flex items-center space-x-2">
        <div class="bg-farm-primary p-2 rounded-lg">
          <i class="fas fa-seedling text-white"></i>
        </div>
        <span class="text-xl font-bold text-gray-800 tracking-tight"
          >FarmSupport</span
        >
      </div>

      <div class="flex items-center space-x-4">
        <select
          id="langSelect"
          class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-full focus:ring-green-500 focus:border-green-500 block p-2 px-4 outline-none"
        >
          <option value="en">English</option>
          <option value="hi">हिन्दी (Hindi)</option>
          <option value="pa">ਪੰਜਾਬੀ (Punjabi)</option>
          <option value="mr">मराठी (Marathi)</option>
          <option value="te">తెలుగు (Telugu)</option>
          <option value="ta">தமிழ் (Tamil)</option>
          <option value="bn">বাংলা (Bengali)</option>
        </select>
      </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-6">
      <!-- Chat Area -->
      <div
        class="glass-card rounded-3xl shadow-xl overflow-hidden flex flex-col"
      >
        <div
          id="chatWindow"
          class="chat-container overflow-y-auto p-4 md:p-6 space-y-4 custom-scrollbar"
        >
          <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t">
          <div id="inputForm" class="relative flex items-center space-x-3">
            <input
              type="text"
              id="userInput"
              class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 pr-12 focus:ring-2 focus:ring-green-600 outline-none transition-all"
              placeholder="Type your message..."
            />
            <button
              id="sendBtn"
              class="bg-farm-primary text-white p-4 rounded-2xl hover:opacity-90 transition-all flex items-center justify-center shadow-lg"
            >
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      const apiKey = "ENTER_API_KEY";
      const MODEL_NAME = "ENTER_MODEL_NAME";

      const chatWindow = document.getElementById("chatWindow");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const langSelect = document.getElementById("langSelect");

      let currentLang = "en";
      let step = 0; // 0: Asking Crop, 1: Asking Problem
      let userData = { crop: "", problem: "" };

      const translations = {
        en: {
          welcome:
            "Welcome to FarmSupport. I am your Agri-Expert. I'm here to help you achieve a better harvest.",
          askCrop:
            "First, please tell me, which crop are you currently working with?",
          askProblem:
            "Got it. Now, please describe the specific problem or symptoms you are noticing with your {crop}.",
          thinking: "Analyzing your query...",
          placeholder: "Type your answer here...",
          error: "I'm having trouble connecting. Please try again.",
          rateLimit: "Server is busy. Retrying for you...",
          expertPrompt:
            "You are an expert Indian Agricultural Scientist named FarmSupport. Always respond in {language}. Provide solutions in short, actionable bullet points. Be professional and encouraging. User is asking about {crop}.",
        },
        hi: {
          welcome:
            "फार्मसपोर्ट में आपका स्वागत है। मैं आपका कृषि-विशेषज्ञ हूँ।",
          askCrop:
            "सबसे पहले, कृपया मुझे बताएं कि आप अभी किस फसल पर काम कर रहे हैं?",
          askProblem:
            "समझ गया। अब, कृपया अपनी {crop} फसल में आ रही विशिष्ट समस्या का वर्णन करें।",
          thinking: "विश्लेषण कर रहा हूँ...",
          placeholder: "अपना उत्तर यहाँ लिखें...",
          error: "कनेक्शन में समस्या। फिर से प्रयास करें।",
          rateLimit: "सर्वर व्यस्त है...",
          expertPrompt:
            "आप FarmSupport नाम के एक विशेषज्ञ भारतीय कृषि वैज्ञानिक हैं। हमेशा {language} में उत्तर दें। समाधान छोटे बुलेट पॉइंट्स में दें। उपयोगकर्ता {crop} के बारे में पूछ रहा है।",
        },
        pa: {
          welcome:
            "ਫਾਰਮਸਪੋਰਟ ਵਿੱਚ ਤੁਹਾਡਾ ਸੁਆਗਤ ਹੈ। ਮੈਂ ਤੁਹਾਡਾ ਖੇਤੀਬਾੜੀ ਮਾਹਰ ਹਾਂ।",
          askCrop:
            "ਸਭ ਤੋਂ ਪਹਿਲਾਂ, ਕਿਰਪਾ ਕਰਕੇ ਮੈਨੂੰ ਦੱਸੋ ਕਿ ਤੁਸੀਂ ਇਸ ਸਮੇਂ ਕਿਹੜੀ ਫਸਲ 'ਤੇ ਕੰਮ ਕਰ ਰਹੇ ਹੋ?",
          askProblem:
            "ਠੀਕ ਹੈ। ਹੁਣ, ਕਿਰਪਾ ਕਰਕੇ ਆਪਣੀ {crop} ਫਸਲ ਵਿੱਚ ਆ ਰਹੀ ਖਾਸ ਸਮੱਸਿਆ ਦਾ ਵਰਣਨ ਕਰੋ।",
          thinking: "ਵਿਸ਼ਲੇਸ਼ਣ ਕਰ ਰਿਹਾ ਹਾਂ...",
          placeholder: "ਆਪਣਾ ਜਵਾਬ ਇੱਥੇ ਲਿਖੋ...",
          error: "ਨੈੱਟਵਰਕ ਵਿੱਚ ਸਮੱਸਿਆ ਹੈ।",
          rateLimit: "ਸਰਵਰ ਰੁੱਝਿਆ ਹੋਇਆ ਹੈ...",
          expertPrompt:
            "ਤੁਸੀਂ FarmSupport ਨਾਮ ਦੇ ਇੱਕ ਮਾਹਰ ਭਾਰਤੀ ਖੇਤੀਬਾੜੀ ਵਿਗਿਆਨੀ ਹੋ। ਹਮੇਸ਼ਾ {language} ਵਿੱਚ ਜਵਾਬ ਦਿਓ। ਉਪਭੋਗਤਾ {crop} ਬਾਰੇ ਪੁੱਛ ਰਿਹਾ ਹੈ।",
        },
        // ... (Other languages follow the same corrected structure)
      };

      const languageMap = {
        en: "English",
        hi: "Hindi",
        pa: "Punjabi",
        mr: "Marathi",
        te: "Telugu",
        ta: "Tamil",
        bn: "Bengali",
      };

      function addMessage(text, sender) {
        const div = document.createElement("div");
        div.className = `flex ${sender === "user" ? "justify-end" : "justify-start"} mb-4 animate-fade-in`;

        const inner = document.createElement("div");
        inner.className = `max-w-[85%] px-5 py-3 ${sender === "user" ? "message-user" : "message-bot shadow-sm"}`;

        // Basic Markdown to HTML conversion
        const formattedText = text
          .replace(/\*(.*?)\*/g, "<strong>$1</strong>")
          .replace(/\n/g, "<br>")
          .replace(/•/g, "<br>•");

        inner.innerHTML = formattedText;
        div.appendChild(inner);
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function showLoader(message = null) {
        if (document.getElementById("temp-loader")) return;
        const msg =
          message ||
          (translations[currentLang]
            ? translations[currentLang].thinking
            : "Thinking...");
        const div = document.createElement("div");
        div.id = "temp-loader";
        div.className = "flex justify-start mb-4";
        div.innerHTML = `<div class="message-bot px-5 py-3 flex items-center space-x-3">
                <div class="loader"></div>
                <span class="text-sm text-gray-500">${msg}</span>
            </div>`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function removeLoader() {
        const loader = document.getElementById("temp-loader");
        if (loader) loader.remove();
      }

      async function fetchAIWithRetry(userText, retries = 5, delay = 1000) {
        const t = translations[currentLang] || translations.en;
        const systemPrompt = t.expertPrompt
          .replace("{language}", languageMap[currentLang])
          .replace("{crop}", userData.crop);

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        const payload = {
          contents: [
            {
              parts: [
                {
                  text: `${systemPrompt}\n\nUser Question: ${userText}`,
                },
              ],
            },
          ],
        };

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (response.status === 429 && retries > 0) {
            showLoader(t.rateLimit);
            await new Promise((r) => setTimeout(r, delay));
            return fetchAIWithRetry(userText, retries - 1, delay * 2);
          }

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          const aiMsg =
            data.candidates?.[0]?.content?.parts?.[0]?.text || t.error;

          removeLoader();
          addMessage(aiMsg, "bot");
        } catch (error) {
          if (retries > 0) {
            await new Promise((r) => setTimeout(r, delay));
            return fetchAIWithRetry(userText, retries - 1, delay * 2);
          }
          removeLoader();
          addMessage(t.error, "bot");
          console.error("API Error:", error);
        }
      }

      function handleWorkflow() {
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, "user");
        userInput.value = "";

        const t = translations[currentLang] || translations.en;

        if (step === 0) {
          userData.crop = text;
          step = 1;
          const nextMsg = t.askProblem.replace("{crop}", text);
          setTimeout(() => addMessage(nextMsg, "bot"), 500);
        } else {
          showLoader();
          fetchAIWithRetry(text);
        }
      }

      function initChat() {
        chatWindow.innerHTML = "";
        step = 0;
        const t = translations[currentLang] || translations.en;
        addMessage(t.welcome, "bot");
        setTimeout(() => addMessage(t.askCrop, "bot"), 600);
        userInput.placeholder = t.placeholder;
      }

      langSelect.addEventListener("change", (e) => {
        currentLang = e.target.value;
        initChat();
      });

      sendBtn.addEventListener("click", handleWorkflow);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleWorkflow();
      });

      window.onload = initChat;
    </script>
  </body>
</html>
